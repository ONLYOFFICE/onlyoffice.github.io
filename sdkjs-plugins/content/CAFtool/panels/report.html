<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- ä»…ç”¨äºå­çª—ä¸çˆ¶æ’ä»¶é€šä¿¡ï¼›ä¸å½±å“æ ·å¼ -->
  <script src="../../v1/plugins.js"></script>
  <meta charset="utf-8"/>
  <title>æ ¼å¼åŒ–é”™è¯¯æŠ¥å‘Š</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#ffffff; --fg:#222; --muted:#666; --soft:#f5f7fa; --line:#e6e8eb;
      --primary:#155EEF; --primary-weak:#e7efff; --danger:#b00020;
      --selbg:#e9f7ef; --selborder:#c9ecd7; --seltext:#0a7a3b; --warn:#b36b00;
    }
    *{box-sizing:border-box}
    html, body { height: 100vh; }
    body{
      margin:0; padding:12px;
      font:14px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC","Microsoft Yahei", sans-serif;
      color:var(--fg); background:var(--bg);
      display:flex; flex-direction:column; gap:10px; overflow:hidden;
    }

    header{
      flex:0 0 auto;
      display:flex; align-items:flex-start; justify-content:space-between; gap:16px;
      border-bottom:1px solid var(--line); padding-bottom:10px;
    }
    h1{font-size:18px; margin:0}
    .meta{font-size:12px; color:var(--muted)}
    #topNotice{
      display:none; padding:8px 12px; border-radius:8px; background:var(--primary-weak); color:#0a2a7a;
      margin-top:6px; font-size:13px;
    }

    .content{ flex:1 1 auto; min-height:0; display:flex; flex-direction:column; overflow:hidden; }
    .sticky{
      position:sticky; top:0; z-index:5;
      background:#fff;
      padding-bottom:8px; margin-bottom:8px;
      border-bottom:1px solid var(--line);
    }

    .stat{ display:flex; gap:12px; flex-wrap:wrap; font-size:12px; color:#333; margin:6px 0 8px; }
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:var(--soft); border:1px solid var(--line)}
    .badge.warn{background:#fff7e6; border-color:#ffe6b3; color:var(--warn)}
    .badge.sel{background:var(--selbg); border-color:var(--selborder); color:var(--seltext);}

    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; }
    button{
      appearance:none; border:1px solid var(--line); background:#fff; color:#111; padding:6px 10px; border-radius:8px;
      cursor:pointer; font-size:13px;
    }
    .toolbar button{ background:#fff; border-color:var(--line); }
    .toolbar button:hover{ background:#fafbfc; }
    button.primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
    button.danger{ background:#fff0f1; border-color:#ffd5da; color:var(--danger); }

    .tablewrap{ flex:1 1 auto; min-height:0; overflow:auto; }
    table{width:100%; border-collapse:collapse; border:1px solid var(--line); background:#fff}
    thead th{
      text-align:left; font-weight:600; font-size:12px; color:#444; background:#fafbfc; border-bottom:1px solid var(--line);
      padding:8px; position:sticky; top:0; z-index:1;
    }
    tbody td{ padding:8px; border-top:1px solid var(--line); vertical-align:top; }
    tbody tr:hover{ background:#fcfdff; }
    .col-check{width:52px}
    .col-idx{width:64px; color:#666}
    .col-rule{width:150px}
    .code{
      white-space:pre-wrap; word-break:break-word; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background:#fbfcfe; border:1px solid var(--line); border-radius:6px; padding:6px 8px;
    }
    .changed{ background:#fff8e6; border-color:#ffe3a6; }
    .empty{ color:#999; font-style:italic }

    footer{
      flex:0 0 auto; margin-top:8px; display:flex; justify-content:space-between; align-items:center; gap:12px;
      border-top:1px solid var(--line); padding-top:10px;
    }
    .hint{font-size:12px; color:#777}
    .right{display:flex; gap:8px; flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>æ ¼å¼åŒ–é”™è¯¯æŠ¥å‘Š</h1>
      <div class="meta" id="metaInfo">ä»é€‰ä¸­æ–‡æœ¬ç”Ÿæˆ Â· ä»¥ä¸‹ä»…æ˜¾ç¤ºâ€œä¼šå‘ç”Ÿå˜åŒ–â€çš„è¡Œ</div>
      <div id="topNotice"></div>
    </div>
  </header>

  <div class="content">
    <div class="sticky">
      <div class="stat" id="statBar"></div>
      <div class="toolbar">
        <button id="btnSelectAll">å…¨é€‰</button>
        <button id="btnSelectNone">å…¨ä¸é€‰</button>
        <button id="btnSelectSpace" title="åªå‹¾é€‰ç©ºæ ¼ç›¸å…³è§„åˆ™ï¼ˆä¸­è‹±/æ•°å­—é—´ã€æ•°å­—-å•ä½ã€ç™¾åˆ†å·ï¼‰">ä»…é€‰ç©ºæ ¼ç›¸å…³</button>
      </div>
    </div>

    <div class="tablewrap">
      <table id="reportTable" aria-label="æŠ¥å‘Šåˆ—è¡¨">
        <thead>
          <tr>
            <th class="col-check">é€‰æ‹©</th>
            <th class="col-idx">è¡Œå·</th>
            <th class="col-rule">é—®é¢˜</th>
            <th>åŸæ–‡</th>
            <th>ä¿®å¤åæ®µè½</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <footer>
    <div class="hint">æç¤ºï¼šæœªå‹¾é€‰çš„è¡Œå°†ä¿æŒåŸæ ·ï¼›å‹¾é€‰çš„è¡Œä¼šæ›¿æ¢ä¸ºå³ä¾§â€œä¿®å¤åæ®µè½â€ã€‚</div>
    <div class="right">
      <!-- <button id="btnSave" class="primary">ç¡®å®šå¹¶ä¿å­˜</button> -->
      <!-- æ–‡æ¡ˆæ”¹ä¸ºâ€œå–æ¶ˆâ€ -->
      <!-- <button id="btnClose" class="danger">å–æ¶ˆ</button> -->
    </div>
  </footer>




  <script>
  try { localStorage.setItem('reportCloseReason', 'open'); } catch(e){}

      
  // â€”â€” ç»Ÿä¸€çš„å‘é€å‡½æ•°ï¼šä¼˜å…ˆ ONLYOFFICE çš„ sendToPluginï¼Œå¤±è´¥å†å›é€€ postMessage â€”â€” //
  // â€”â€” ç»Ÿä¸€çš„å‘é€å‡½æ•°ï¼šä¼˜å…ˆ sendToPluginï¼Œå¤±è´¥å†å›é€€ postMessage â€”â€” //
  function sendToHost(payload) {
    try {
      if (window.Asc && window.Asc.plugin && typeof window.Asc.plugin.sendToPlugin === 'function') {
        window.Asc.plugin.sendToPlugin("onWindowMessage", payload);
        return;
      }
    } catch (e) { }
    try {
      parent.postMessage({ source: 'zhlint', payload }, '*'); // å›é€€ï¼ˆé€šå¸¸ç”¨ä¸åˆ°ï¼‰
    } catch (e) { }
  }


  (function(){
    // ===== è¯»å–æ•°æ® =====
    const reportRaw = localStorage.getItem('zhlintReport') || '[]';
    const originalLines = JSON.parse(localStorage.getItem('originalLines') || '[]');
    const fixedLines    = JSON.parse(localStorage.getItem('fixedLines') || '[]');
    const report = safeParse(reportRaw, []);

    // é¡¶éƒ¨æ˜¾ç¤ºâ€œç©ºæ ¼ç­–ç•¥â€
    showStrategySummary();

    if (!Array.isArray(originalLines) || !Array.isArray(fixedLines) || originalLines.length !== fixedLines.length) {
      alert('æŠ¥å‘Šæ•°æ®å¼‚å¸¸ï¼šoriginalLines / fixedLines ç¼ºå¤±æˆ–é•¿åº¦ä¸ä¸€è‡´');
      return;
    }

    // ==== å°† reportï¼ˆä»…å«æœ‰é—®é¢˜çš„è¡Œï¼‰æ˜ å°„å›åŸå§‹è¡Œå· ====>
    const idxMap = [];
    let start = 0;
    report.forEach(item => {
      const { original, fixed, errors } = item || {};
      const found = findNextIndex(originalLines, fixedLines, original, fixed, start);
      if (found >= 0) {
        idxMap.push({ idx: found, original, fixed, errors: errors || [] });
        start = found + 1;
      }
    });
    if (idxMap.length === 0) {
      for (let i=0;i<originalLines.length;i++){
        if (originalLines[i] !== fixedLines[i]) {
          idxMap.push({ idx:i, original: originalLines[i], fixed: fixedLines[i], errors: [] });
        }
      }
    }

    renderStat(originalLines.length, idxMap.length, idxMap);
    renderTable(idxMap);
    bindActions(idxMap, originalLines, fixedLines);
    updateSelectedBadge();

    // ===== å·¥å…·å‡½æ•° =====
    function safeParse(s, d){ try{return JSON.parse(s);}catch(e){return d;} }
    function findNextIndex(origArr, fixArr, o, f, startAt){
      for (let i=startAt;i<origArr.length;i++){ if (origArr[i] === o && fixArr[i] === f) return i; }
      return -1;
    }
    function showStrategySummary(){
      const cjk = localStorage.getItem('opt_cjkAnSpace') === '1';
      const nu  = localStorage.getItem('opt_numUnitSpace') === '1';
      const tip = document.getElementById('topNotice');
      const a = cjk ? "æ·»åŠ ç©ºæ ¼" : "åˆ é™¤ç©ºæ ¼";
      const b = nu  ? "æ·»åŠ ç©ºæ ¼" : "åˆ é™¤ç©ºæ ¼";
      tip.textContent = `æœ¬æ¬¡ç©ºæ ¼ç­–ç•¥ï¼šä¸­æ–‡-è‹±æ–‡/æ•°å­— = ${a}ï¼›æ•°å­—-å•ä½/ç¬¦å·ï¼ˆå«ç™¾åˆ†å·ï¼‰ = ${b}ã€‚`;
      tip.style.display = 'block';
    }

    function renderStat(total, changed, rows){
      const spaceRules = new Set([
        'spaceBetweenMixedLang:add','spaceBetweenMixedLang:remove',
        'numberUnitSpacing:add','numberUnitSpacing:remove',
        'percentSpacing:add','percentSpacing:remove'
      ]);
      let spaceCount = 0, otherCount = 0;
      rows.forEach(r=>{
        const rules = (r.errors||[]).map(e=>e.rule).filter(Boolean);
        if (rules.length === 0) {
          if (guessSpaceChange(r.original, r.fixed)) spaceCount++; else otherCount++;
        } else {
          let hasSpace=false, hasOther=false;
          rules.forEach(rule=>{ if (spaceRules.has(rule)) hasSpace=true; else hasOther=true; });
          if (hasSpace) spaceCount++;
          if (hasOther) otherCount++;
        }
      });
      const bar = document.getElementById('statBar');
      bar.innerHTML = `
        <span class="badge">æ€»è¡Œæ•° ${total}</span>
        <span class="badge warn">å­˜åœ¨é”™è¯¯çš„è¡Œæ•° ${changed}</span>
        <span class="badge">ç©ºæ ¼ç›¸å…³ ${spaceCount}</span>
        <span class="badge">å…¶å®ƒ ${otherCount}</span>
        <span class="badge sel" id="selCountBadge">é€‰ä¸­çš„è¡Œæ•° 0</span>`;
    }

    function guessSpaceChange(a,b){
      if (a.replace(/\s+/g,'') === b.replace(/\s+/g,'')) return a !== b;
      return false;
    }

    function renderTable(rows){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      rows.forEach(({idx, original, fixed, errors})=>{
        const tr = document.createElement('tr'); tr.dataset.idx = String(idx);

        const tdCheck = document.createElement('td');
        tdCheck.className = 'col-check';
        tdCheck.innerHTML = `<input type="checkbox" class="row-check" checked aria-label="é€‰æ‹©ç¬¬${idx+1}è¡Œ">`;
        tr.appendChild(tdCheck);

        const tdIdx = document.createElement('td');
        tdIdx.className = 'col-idx';
        tdIdx.textContent = String(idx + 1);
        tr.appendChild(tdIdx);

        const tdRule = document.createElement('td');
        tdRule.className = 'col-rule';
        tdRule.appendChild(renderRule(errors));
        tr.appendChild(tdRule);

        const tdOriginal = document.createElement('td');
        tdOriginal.innerHTML = `<div class="code">${escapeHTML(original || '').trim() || '<span class="empty">ï¼ˆç©ºè¡Œï¼‰</span>'}</div>`;
        tr.appendChild(tdOriginal);

        const tdFixed = document.createElement('td');
        tdFixed.innerHTML = `<div class="code changed">${escapeHTML(fixed || '').trim() || '<span class="empty">ï¼ˆç©ºè¡Œï¼‰</span>'}</div>`;
        tr.appendChild(tdFixed);

        tbody.appendChild(tr);
      });

      tbody.addEventListener('change', (e)=>{
        if (e.target && e.target.classList.contains('row-check')) updateSelectedBadge();
      });
    }

    function renderRule(errors){
      const wrap = document.createElement('div');
      const hiddenRules = new Set(['fullwidthPunctuation','spaceBetweenMixedLang:add']);
      const list = (errors || []).filter(e => !hiddenRules.has(e.rule));
      const text = (list.length ? list : (errors||[])).map(e => e.message).join('ï¼›');
      wrap.innerHTML = `<div style="color:#555;font-size:12px">${escapeHTML(text || 'å­˜åœ¨æ ¼å¼ä¼˜åŒ–ï¼ˆç©ºæ ¼/æ ‡ç‚¹ï¼‰')}</div>`;
      return wrap;
    }

    function bindActions(rows, original, fixed){
      const tbody = document.getElementById('tbody');

      document.getElementById('btnSelectAll').onclick  = () => {
        tbody.querySelectorAll('.row-check').forEach(ch=> ch.checked = true);
        updateSelectedBadge();
      };
      document.getElementById('btnSelectNone').onclick = () => {
        tbody.querySelectorAll('.row-check').forEach(ch=> ch.checked = false);
        updateSelectedBadge();
      };
      document.getElementById('btnSelectSpace').onclick = () => {
        const spaceRules = new Set(['spaceBetweenMixedLang:add','spaceBetweenMixedLang:remove','numberUnitSpacing:add','numberUnitSpacing:remove','percentSpacing:add','percentSpacing:remove']);
        const isSpaceRow = (r) => (r.errors && r.errors.length) ? r.errors.some(e => spaceRules.has(e.rule)) : guessSpaceChange(r.original, r.fixed);
        tbody.querySelectorAll('.row-check').forEach(ch=> ch.checked = false);
        Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
          const idx = +tr.dataset.idx;
          const row = rows.find(r => r.idx === idx);
          if (row && isSpaceRow(row)) tr.querySelector('.row-check').checked = true;
        });
        updateSelectedBadge();
      };

    
      // document.getElementById('btnSave').onclick = () => {
      //   try { localStorage.setItem('reportCloseReason', 'saved'); } catch(e){}

      //   const base = JSON.parse(localStorage.getItem('currentSelectionLines') || 'null') || original.slice();
      //   const applyLines = buildApplyResult(rows, base, fixed, true);
      //   if (!applyLines) {
      //     // ä½ åŸæœ‰çš„é”™è¯¯æç¤ºä¿ç•™
      //     showNotice && showNotice('âŒ å½“å‰é€‰æ‹©åŒºè¡Œæ•°å¼‚å¸¸ï¼Œæ— æ³•ä¿å­˜', true);
      //     return;
      //   }

      //   // 1) å†™å…¥ç”±ä¸»æ’ä»¶åœ¨çª—å£å…³é—­æ—¶è¯»å–çš„ç»“æœï¼ˆä¿æŒç°æœ‰é€»è¾‘ï¼‰
      //   localStorage.setItem('batchReplaceResult', JSON.stringify(applyLines));

      //   // 2) ğŸ”” æ–°å¢ï¼šåŠé€æ˜æç¤ºï¼ˆå¤åˆ¶æˆåŠŸç±»ï¼‰
      //   showToast('å…³é—­æœ¬çª—å£åï¼Œç³»ç»Ÿå°†ä¾æ®æ‚¨å·²å‹¾é€‰çš„å†…å®¹ä¿å­˜å¹¶åº”ç”¨ä¿®æ”¹ã€‚');

      //   // ä½ åŸæœ‰çš„ç»Ÿè®¡æç¤ºä¸è‡ªåŠ¨å…³é—­é€»è¾‘ä¿ç•™
      //   const checkedCount = Array.from(document.querySelectorAll('.row-check')).filter(ch => ch.checked).length;
      //   const reportArr = JSON.parse(localStorage.getItem('zhlintReport') || '[]');
      //   const msg = `âœ… å·²æ£€æµ‹åˆ° ${reportArr.length} æ¡é—®é¢˜ï¼Œæ‚¨å‹¾é€‰äº† ${checkedCount} æ¡ã€‚çª—å£å°†è‡ªåŠ¨å…³é—­å¹¶å®Œæˆæ›¿æ¢ã€‚`;
      //   if (typeof showNotice === 'function') showNotice(msg);

      //   setTimeout(() => window.close(), 800);
      // };

      // â€”â€” æŠŠä¿å­˜æµç¨‹æŠ½æˆå‡½æ•°ï¼Œä¾›å¤šå¤„å¤ç”¨ â€”â€” //
      function applySelectedAndClose() {
        try { localStorage.setItem('reportCloseReason', 'saved'); } catch (e) { }

        const base = JSON.parse(localStorage.getItem('currentSelectionLines') || 'null') || original.slice();
        const applyLines = buildApplyResult(rows, base, fixed, true);
        if (!applyLines) {
          showNotice && showNotice('âŒ å½“å‰é€‰æ‹©åŒºè¡Œæ•°å¼‚å¸¸ï¼Œæ— æ³•ä¿å­˜', true);
          return;
        }

          // âœ… æ–°å¢ï¼šæŠŠç»“æœè½ç›˜ï¼Œçˆ¶çª—å¯å…œåº•è¯»å–
        try { localStorage.setItem('batchReplaceResult', JSON.stringify(applyLines)); } catch(e){}
        try { localStorage.setItem('reportApplyReady', '1'); } catch(e){}

        // ç›´æ¥æŠŠç»“æœå‘ç»™çˆ¶ç«¯ï¼ˆcode.js çš„ onMessage â†’ apply-now ä¼šæ›¿æ¢å¹¶å…³çª—ï¼‰
        sendToHost({ type: 'apply-now', lines: applyLines });

        showToast('å·²ä¿å­˜å¹¶åº”ç”¨å‹¾é€‰çš„ä¿®æ”¹ã€‚');
        setTimeout(() => { try { window.close(); } catch (e) { } }, 1000);
      }

      // 1) å¦‚æœé¡µè„šçœŸçš„æœ‰æŒ‰é’®å†ç»‘å®šï¼ˆä½ å½“å‰æ³¨é‡Šæ‰äº†ï¼Œä¸ä¼šæŠ¥é”™ï¼‰
      const btnSaveEl = document.getElementById('btnSave');
      if (btnSaveEl) btnSaveEl.addEventListener('click', applySelectedAndClose);

      // 2) æ ‡å‡†è·¯å¾„ï¼šçˆ¶çª—å†™å…¥ reportApplyNow=1 æ—¶è§¦å‘
      window.addEventListener('storage', function (e) {
        if (e.key === 'reportApplyNow' && e.newValue === '1') {
          try { localStorage.removeItem('reportApplyNow'); } catch (_) { }
          applySelectedAndClose();
        }
      });

      // 3) å…œåº•è½®è¯¢ï¼šæŸäº›ç¯å¢ƒä¸‹ storage äº‹ä»¶ä¸ä¼šè§¦å‘ï¼ˆfile://ã€æ²™ç›’ç­‰ï¼‰
      let _applyPoll = setInterval(() => {
        if (localStorage.getItem('reportApplyNow') === '1') {
          try { localStorage.removeItem('reportApplyNow'); } catch (_) { }
          applySelectedAndClose();
        }
      }, 120);
      window.addEventListener('pagehide', () => clearInterval(_applyPoll));


      // â€”â€” å–æ¶ˆï¼šå¯¹é½ space-options.html çš„è¡Œä¸ºï¼Œç›´æ¥å…³é—­çª—å£ â€”â€” //
      // document.getElementById('btnClose').onclick = () => {
      //   window.close();
      // };

      // ========= ç›‘å¬çˆ¶çª—è§¦å‘çš„â€œä¸€é”®ä¿å­˜å¹¶ä¿®æ”¹â€ =========
      window.addEventListener('storage', function (e) {
        if (e.key !== 'reportApplyNow' || e.newValue !== '1') return;
        // æ¸…æ ‡è®°ï¼Œé˜²æŠ–
        try { localStorage.removeItem('reportApplyNow'); } catch (err) { }

        // æ ‡è®°ä¸ºå·²ä¿å­˜ï¼ˆé˜²æ­¢çˆ¶ç«¯æŠŠè¿™æ¬¡å…³é—­å½“æˆâ€œæœªä¿å­˜â€ï¼‰
        try { localStorage.setItem('reportCloseReason', 'saved'); } catch (err) { }

        // â€”â€” ä¸‹é¢å°±æ˜¯ä½  btnSave.onclick é‡Œçš„é‚£å¥— â€”â€” //
        const base = JSON.parse(localStorage.getItem('currentSelectionLines') || 'null') || original.slice();
        const applyLines = buildApplyResult(rows, base, fixed, true);
        if (!applyLines) {
          showNotice && showNotice('âŒ å½“å‰é€‰æ‹©åŒºè¡Œæ•°å¼‚å¸¸ï¼Œæ— æ³•ä¿å­˜', true);
          return;
        }

        // ç›´æ¥æŠŠç»“æœå‘ç»™çˆ¶ç«¯ï¼ˆèµ°ä½  code.js é‡Œçš„ onMessage â†’ apply-nowï¼‰
        sendToHost({ type: 'apply-now', lines: applyLines });

        // ç»™ä¸ªè½»æç¤º & åˆä¸Šçª—å£ï¼ˆçˆ¶ç«¯å…œåº•ä¹Ÿä¼šå…³ï¼‰
        showToast('å·²ä¿å­˜å¹¶åº”ç”¨å‹¾é€‰çš„ä¿®æ”¹ã€‚');
        setTimeout(() => { try { window.close(); } catch (e) { } }, 1000);
      });








    }

    function updateSelectedBadge(){
      const tbody = document.getElementById('tbody');
      const sel = Array.from(tbody.querySelectorAll('.row-check')).filter(ch => ch.checked).length;
      const badge = document.getElementById('selCountBadge');
      if (badge) badge.textContent = `é€‰ä¸­çš„è¡Œæ•° ${sel}`;
    }

    // åŸºäºâ€œå½“å‰åŸºçº¿è¡Œâ€æŒ‰å‹¾é€‰è¦†ç›– fixed
    function buildApplyResult(rows, baseLines, fixed, respectCheckbox){
      const out = baseLines.slice();
      const tbody = document.getElementById('tbody');
      if (out.length === 0) { alert('æ— æ³•åº”ç”¨ï¼šå½“å‰é€‰æ‹©åŒºè¡Œæ•°å¼‚å¸¸'); return null; }
      Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
        const idx = +tr.dataset.idx;
        const checked = tr.querySelector('.row-check')?.checked;
        if (!respectCheckbox || checked) out[idx] = fixed[idx];
      });
      return out;
    }

    function escapeHTML(str){
      return String(str).replace(/[&<>"'`]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[s]));
    }

    // ğŸ”” è½»é‡ Toastï¼šåŠé€æ˜ã€è‡ªåŠ¨æ¶ˆå¤±ï¼Œä¸å½±å“ç°æœ‰æ ·å¼
    function showToast(text, duration = 600) {
      const el = document.createElement('div');
      el.textContent = text;
      el.setAttribute('role', 'status');
      el.setAttribute('aria-live', 'polite');
      Object.assign(el.style, {
        position: 'fixed',
        top: '18px',
        left: '50%',
        transform: 'translateX(-50%) translateY(-6px)',
        padding: '8px 20px',
        borderRadius: '8px',
        background: 'rgba(0,0,0,0.72)',
        color: '#fff',
        fontSize: '13px',
        boxShadow: '0 6px 18px rgba(0,0,0,0.25)',
        zIndex: 9999,
        pointerEvents: 'none',
        opacity: 0,
        transition: 'opacity .18s ease, transform .18s ease'
      });
      document.body.appendChild(el);
      requestAnimationFrame(() => {
        el.style.opacity = 1;
        el.style.transform = 'translateX(-50%) translateY(0)';
      });
      setTimeout(() => {
        el.style.opacity = 0;
        el.style.transform = 'translateX(-50%) translateY(-6px)';
        setTimeout(() => el.remove(), 200);
      }, duration);
    }

    // æœªç‚¹å‡»ä¿å­˜è€Œå…³é—­çª—å£ï¼šæ ‡è®°ä¸º closed_without_save
    window.addEventListener('pagehide', function () {
      try {
        if (localStorage.getItem('reportCloseReason') !== 'saved') {
          localStorage.setItem('reportCloseReason', 'closed_without_save');
        }
      } catch (e) { }
    });


  })();
  </script>
</body>
</html>
