<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ ¼å¼åŒ–é”™è¯¯æŠ¥å‘Š</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      height: 100%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .fixed-header {
      padding: 10px;
      background: white;
      flex-shrink: 0;
    }

    .scroll-table-wrapper {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #fff;
    }

    h2 {
      margin-top: 0;
    }

    p.tip {
      font-size: 14px;
      margin-bottom: 12px;
      color: #333;
    }

    .notice {
      background-color: #e6f4ea;
      color: #0a5e2a;
      border: 1px solid #b4dfc4;
      padding: 10px 16px;
      font-size: 14px;
      margin-bottom: 12px;
      border-radius: 4px;
      display: none;
    }

    .action-bar {
      margin-bottom: 12px;
    }

    .action-bar button {
      margin-right: 8px;
      padding: 5px 12px;
      font-size: 14px;
      cursor: pointer;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      vertical-align: top;
    }

    th {
      background-color: #f2f2f2;
    }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      margin: 0;
    }

    td:last-child {
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>

  <div class="fixed-header">
    <p class="tip">
      æˆ‘ä»¬æ£€æµ‹åˆ°äº†ä¸€äº›æ ¼å¼é—®é¢˜ï¼Œè¯·é€‰æ‹©æ‚¨å¸Œæœ›ä¿®æ­£çš„éƒ¨åˆ†ã€‚ç‚¹å‡»â€œä¿å­˜éœ€è¦ä¿®æ”¹çš„å†…å®¹â€åï¼Œå°†æ˜¾ç¤ºæ‚¨çš„é€‰æ‹©æƒ…å†µã€‚ç¡®è®¤åç‚¹å‡»æç¤ºæ¡†å³ä¸Šè§’ âœ• å…³é—­é¡µé¢ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ›¿æ¢å¯¹åº”å†…å®¹ã€‚
    </p>

    <div id="topNotice" class="notice"></div>

    <div class="action-bar">
      <button onclick="replaceSelected()">ä¿å­˜éœ€è¦ä¿®æ”¹çš„å†…å®¹</button>
      <button onclick="selectAll(true)">å…¨é€‰</button>
      <button onclick="selectAll(false)">å…¨ä¸é€‰</button>
    </div>
  </div>

  <div class="scroll-table-wrapper">
    <table>
      <thead>
        <tr>
          <th><input type="checkbox" onclick="selectAll(this.checked)"></th>
          <th>#</th>
          <th>åŸå§‹æ®µè½</th>
          <th>ä¿®å¤åæ®µè½</th>
          <th style="width: 30%;">è§¦å‘è§„åˆ™ä¸æç¤º</th>
        </tr>
      </thead>
      <tbody id="reportBody">
        <tr><td colspan="5">åŠ è½½ä¸­...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const data = JSON.parse(localStorage.getItem('zhlintReport') || '[]');
    const tbody = document.getElementById('reportBody');
    tbody.innerHTML = '';

    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5">æš‚æ— é”™è¯¯æŠ¥å‘Š</td></tr>';
    } else {
      data.forEach((item, index) => {
        const tr = document.createElement('tr');
        const errorInfo = item.errors.map(err => {
          if (typeof err === 'string') return `â—${err}`;
          if (typeof err === 'object' && err.message) return `â—${err.message}`;
          return "â“æœªçŸ¥æ ¼å¼";
        }).join('<br>');

        tr.innerHTML = `
          <td><input type="checkbox" class="row-checkbox" data-index="${index}" checked></td>
          <td>${index + 1}</td>
          <td><pre>${item.original}</pre></td>
          <td><pre>${item.fixed}</pre></td>
          <td>${errorInfo}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function replaceSelected() {
      console.log("ğŸŸ¡ æ‰§è¡Œ replaceSelected");

      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
      console.log("âœ… å‹¾é€‰ç´¢å¼•ï¼š", indices);

      const original = JSON.parse(localStorage.getItem('originalLines') || '[]');
      const fixed = JSON.parse(localStorage.getItem('fixedLines') || '[]');
      const report = JSON.parse(localStorage.getItem('zhlintReport') || '[]');

      if (original.length !== fixed.length) {
        console.error("âŒ åŸå§‹ä¸ä¿®å¤è¡Œæ•°ä¸ä¸€è‡´");
        showNotice("âŒ åŸå§‹ä¸ä¿®å¤è¡Œæ•°ä¸ä¸€è‡´ï¼Œæ— æ³•æ›¿æ¢", true);
        return;
      }

      const result = original.map((line, i) => indices.includes(i) ? fixed[i] : line);
      console.log("ğŸ“¦ æ„å»ºæ›¿æ¢ç»“æœï¼š", result);

      localStorage.setItem('batchReplaceResult', JSON.stringify(result));
      console.log("âœ… å·²å†™å…¥ batchReplaceResult");

      const msg = `âœ… å·²æ£€æµ‹åˆ° ${report.length} æ¡é—®é¢˜ï¼Œæ‚¨å‹¾é€‰äº† ${indices.length} æ¡ã€‚çª—å£å°†è‡ªåŠ¨å…³é—­å¹¶å®Œæˆæ›¿æ¢ã€‚`;
      showNotice(msg);

      setTimeout(() => {
        window.close();
      }, 2000);
    }

    function selectAll(checked) {
      document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = checked);
    }

    function showNotice(message, isError = false) {
      const box = document.getElementById('topNotice');
      box.textContent = message;
      box.style.backgroundColor = isError ? '#fdecea' : '#e6f4ea';
      box.style.color = isError ? '#b13029' : '#0a5e2a';
      box.style.borderColor = isError ? '#f5c6cb' : '#b4dfc4';
      box.style.display = 'block';
    }
  </script>

</body>
</html>
